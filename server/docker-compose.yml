x-common: &common
  networks:
    - micro-network
  deploy:
    resources:
      limits:
        memory: ${MEM_LIMIT}

x-java-env: &java-env
  SPRING_PROFILES_ACTIVE: docker
  EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: ${EUREKA_SERVER}
  SPRING_DATASOURCE_USERNAME: ${DB_USERNAME}
  SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}

services:
  zookeeper:
    image: confluentinc/cp-zookeeper:7.4.0
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
    <<: *common

  kafka:
    image: confluentinc/cp-kafka:7.4.0
    depends_on: [zookeeper]
    ports: ["9092:9092"]
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    <<: *common

  phpmyadmin:
    image: phpmyadmin:latest
    container_name: phpmyadmin
    ports:
      - "8088:80"
    environment:
      - PMA_HOST=mysql
      - PMA_USER=root
      - PMA_PASSWORD=${DB_PASSWORD}
      - APACHE_SERVER_NAME=localhost
    networks:
      - micro-network
    depends_on:
      mysql:
        condition: service_healthy
    <<: *common

  mysql:
    image: mysql:8.0
    container_name: mysql
    ports: ["3306:3306"]
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
    volumes:
      - mysql_data:/var/lib/mysql
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD", "mysqladmin" ,"ping", "-h", "localhost", "-u", "root", "-p${DB_PASSWORD}"]
      interval: 30s
      retries: 5
    <<: *common

  mongodb:
    image: mongo:latest
    container_name: mongodb
    ports: ["27017:27017"]
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 30s
    <<: *common

  discovery-server:
    build: ./discovery-server
    container_name: discovery-server
    ports: ["8761:8761"]
    <<: *common

  api-gateway:
    build: ./api-gateway
    container_name: api-gateway
    ports: ["8080:8080"]
    depends_on: [discovery-server]
    environment:
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: ${EUREKA_SERVER}
    <<: *common

  auth-service:
    build: ./auth-service
    container_name: auth-service
    ports: ["9000:9000"]
    depends_on:
      mysql: { condition: service_healthy }
    environment:
      <<: *java-env
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/dr_robe_auth
    <<: *common

  trading-service:
    build: ./trading-service
    container_name: trading-service
    ports: ["8081:8081"]
    depends_on:
      mysql: { condition: service_healthy }
    environment:
      <<: *java-env
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/dr_robe_trading
    <<: *common

  shop-service:
    build: ./shop-service
    container_name: shop-service
    ports: ["8082:8082"]
    depends_on:
      mysql: { condition: service_healthy }
    environment:
      <<: *java-env
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/dr_robe_shop
    <<: *common

  clinic-service:
    build: ./clinic-service
    container_name: clinic-service
    ports: ["8083:8083"]
    depends_on:
      mongodb: { condition: service_healthy }
    environment:
      SPRING_PROFILES_ACTIVE: docker
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: ${EUREKA_SERVER}
      SPRING_DATA_MONGODB_URI: ${MONGODB_URI}/dr_robe_clinic
    <<: *common

  hotel-service:
    build: ./hotel-service
    container_name: hotel-service
    ports: ["8084:8084"]
    depends_on:
      mysql: { condition: service_healthy }
    environment:
      <<: *java-env
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/dr_robe_hotel
    <<: *common

  spa-service:
    build: ./spa-service
    container_name: spa-service
    ports: ["8085:8085"]
    depends_on:
      mysql: { condition: service_healthy }
    environment:
      <<: *java-env
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/dr_robe_spa
    <<: *common

  staff-service:
    build: ./staff-service
    container_name: staff-service
    ports: ["8086:8086"]
    depends_on:
      mysql: { condition: service_healthy }
    environment:
      <<: *java-env
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/dr_robe_staff
    <<: *common

  notification-service:
    build: ./notification-service
    container_name: notification-service
    ports: ["8090:8090"]
    depends_on: [kafka]
    environment:
      SPRING_PROFILES_ACTIVE: docker
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: ${EUREKA_SERVER}
      SPRING_KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_SERVER}
    <<: *common

  payment-service:
    build: ./payment-service
    container_name: payment-service
    ports: ["8091:8091"]
    depends_on:
      mysql: { condition: service_healthy }
    environment:
      <<: *java-env
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/dr_robe_payment
    <<: *common

networks:
  micro-network:
    driver: bridge

volumes:
  mysql_data:
  mongo_data: